<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vite + React</title>
  </head>
  <body>
    <!-- Botcopy embed -->
    <div
      id="botcopy-embedder-d7lcfheammjct"
      class="botcopy-embedder-d7lcfheammjct"
      data-botId="68c2ec57c3f8c4d5ded12497"
    >
      <script>
        var s = document.createElement('script');
        s.type = 'text/javascript';
        s.async = true;
        s.src = 'https://widget.botcopy.com/js/injection.js';
        document.getElementById('botcopy-embedder-d7lcfheammjct').appendChild(s);
      </script>
    </div>

    <!-- Persistence: inject into EVERY outbound request + safe coercion + debug -->
    <script>
      (function () {
        const STORAGE_KEY = 'demo.is_new_user';

        // Coerce anything ("false"/"true", 0/1) -> boolean
        function toBool(v) {
          if (typeof v === 'boolean') return v;
          if (typeof v === 'number') return v !== 0;
          if (typeof v === 'string') return v.trim().toLowerCase() === 'true';
          return Boolean(v);
        }

        // Ensure default key exists and log it
        try {
          if (localStorage.getItem(STORAGE_KEY) === null) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(true));
            console.log('[persist:init] created', STORAGE_KEY, '→', true);
          } else {
            console.log('[persist:init] found', STORAGE_KEY, '→', JSON.parse(localStorage.getItem(STORAGE_KEY)));
          }
        } catch (e) {
          console.warn('[persist:init] localStorage unavailable', e);
        }

        // Botcopy event queue shim (don’t overwrite if SDK already defined .on)
        window.Botcopy = window.Botcopy || {};
        if (typeof window.Botcopy.on !== 'function') {
          const q = (window.__bcq = window.__bcq || []);
          window.Botcopy.on = function (evt, fn) { q.push([evt, fn]); };
        }

        // Inject is_new_user into EVERY outbound request (covers "Clear history" new sessions)
        Botcopy.on('pre_request', function (req) {
          try {
            const stored = toBool(JSON.parse(localStorage.getItem(STORAGE_KEY) || 'true'));

            // Attach to params (DF CX sees these as session params)
            req.parameters = req.parameters || {};
            req.parameters.is_new_user = stored;

            // Some SDK builds also pass via payload.parameters
            if (req.payload) {
              req.payload.parameters = req.payload.parameters || {};
              req.payload.parameters.is_new_user = stored;
            }

            console.log('[pre_request] is_new_user →', stored);
          } catch (e) {
            console.warn('[pre_request] inject failed', e);
          }
        });

        // Persist flips from the bot; DO NOT echo immediately (avoids MobX race)
        Botcopy.on('action', function (payload) {
          try {
            const m = payload?.training || payload?.message || payload?.action?.message;
            if (m?.type === 'training' && m?.command === 'set_is_new_user') {
              const val = toBool(m?.parameters?.is_new_user);
              localStorage.setItem(STORAGE_KEY, JSON.stringify(val));
              console.log('[persist] set is_new_user =', val);

              // If you want to reflect into the live session, defer slightly:
              // setTimeout(() => {
              //   (Botcopy.send || Botcopy.sendMessage)?.({
              //     message: {
              //       type: 'training',
              //       command: 'load_is_new_user',
              //       parameters: { is_new_user: val }
              //     }
              //   });
              //   console.log('[persist] echoed load_is_new_user after defer');
              // }, 120);
            }
          } catch (e) {
            console.warn('[action] handler error', e);
          }
        });
      })();
    </script>

    <!-- Your React app -->
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>
