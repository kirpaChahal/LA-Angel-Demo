<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vite + React</title>
  </head>
  <body>
    <!-- Botcopy embed -->
    <div
      id="botcopy-embedder-d7lcfheammjct"
      class="botcopy-embedder-d7lcfheammjct"
      data-botId="68c2ec57c3f8c4d5ded12497"
    >
      <script>
        var s = document.createElement('script');
        s.type = 'text/javascript';
        s.async = true;
        s.src = 'https://widget.botcopy.com/js/injection.js';
        document.getElementById('botcopy-embedder-d7lcfheammjct').appendChild(s);
      </script>
    </div>

    <!-- Persistence: bc-initialized + setCXParameters (no pre_request) -->
    <script>
      (function () {
        const STORAGE_KEY = 'demo.is_new_user';

        // Coerce anything ("false"/"true", 0/1) -> boolean
        function toBool(v) {
          if (typeof v === 'boolean') return v;
          if (typeof v === 'number') return v !== 0;
          if (typeof v === 'string') return v.trim().toLowerCase() === 'true';
          return Boolean(v);
        }

        // Ensure default key exists (first visit → true)
        try {
          if (localStorage.getItem(STORAGE_KEY) === null) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(true));
            console.log('[persist:init] created', STORAGE_KEY, '→', true);
          } else {
            console.log('[persist:init] found', STORAGE_KEY, '→', JSON.parse(localStorage.getItem(STORAGE_KEY)));
          }
        } catch (e) {
          console.warn('[persist:init] localStorage unavailable', e);
        }

        // Prime the NEXT CX request with our stored flag
        function primeNextRequestFromStorage() {
          try {
            const stored = toBool(JSON.parse(localStorage.getItem(STORAGE_KEY) || 'true'));
            if (window.Botcopy && typeof window.Botcopy.setCXParameters === 'function') {
              window.Botcopy.setCXParameters({
                // webhookHeaders: { ... } // optional auth headers if you use them
                parameters: { is_new_user: stored }
              });
              console.log('[bc-initialized] setCXParameters → is_new_user =', stored);
            } else {
              console.warn('Botcopy.setCXParameters not available yet');
            }
          } catch (e) {
            console.warn('primeNextRequestFromStorage failed', e);
          }
        }

        // Fire after the chat window initializes (first load, refresh, Clear history)
        window.addEventListener('bc-initialized', primeNextRequestFromStorage);

        // Fallback: some builds also expose a "ready" hook
        if (window.Botcopy?.on) {
          window.Botcopy.on('ready', primeNextRequestFromStorage);
        }

        // Persist flips from the bot (TRAINING-ONLY to avoid MST races)
        if (window.Botcopy?.on) {
          window.Botcopy.on('action', function (payload) {
            try {
              const t = payload?.training;
              if (t?.type === 'training' && t?.command === 'set_is_new_user') {
                const val = toBool(t?.parameters?.is_new_user);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(val));
                console.log('[persist] is_new_user =', val);

                // Also prime the next request immediately so CX stays in sync
                if (typeof window.Botcopy.setCXParameters === 'function') {
                  window.Botcopy.setCXParameters({ parameters: { is_new_user: val } });
                }
              }
            } catch (e) {
              console.warn('[action] training handler error', e);
            }
          });
        }
      })();
    </script>

    <!-- Your React app -->
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>
